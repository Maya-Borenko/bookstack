name: KCS Knowledge Base Sync
on:
  issues:
    types: [opened, edited, closed, reopened]
  issue_comment:
    types: [created]

jobs:
  sync-to-bookstack:
    runs-on: ubuntu-latest
    if: contains(github.event.issue.labels.*.name, 'knowledge-base')
    steps:
      - name: Debug - Show Labels
        run: |
          echo "=== DEBUG: Issue Information ==="
          echo "Issue #${{ github.event.issue.number }}"
          echo "Title: ${{ github.event.issue.title }}"
          echo "Labels: ${{ toJson(github.event.issue.labels) }}"
          echo "Label names: ${{ join(github.event.issue.labels.*.name, ', ') }}"
          echo "Has 'knowledge-base' label: ${{ contains(github.event.issue.labels.*.name, 'knowledge-base') }}"

      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup Node and install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          npm install marked

      - name: Generate HTML from Markdown
        id: generate_html
        run: |
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–ª–æ issue –≤ —Ñ–∞–π–ª
          echo "${{ github.event.issue.body }}" > issue_body.md
          
          # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º HTML
          HTML_CONTENT=$(node -e "
            const { marked } = require('marked');
            const fs = require('fs');
            const issueBody = fs.readFileSync('issue_body.md', 'utf8');
            const html = marked.parse(issueBody);
            console.log(html);
          ")
          
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –≤—ã–≤–æ–¥–∞
          echo "html_content<<EOF" >> $GITHUB_ENV
          echo "$HTML_CONTENT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          echo "HTML —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω (–¥–ª–∏–Ω–∞: ${#HTML_CONTENT} —Å–∏–º–≤–æ–ª–æ–≤)"

      - name: Get Book ID for "Githab Issues"
        id: get_book_id
        env:
          API_ID: ${{ secrets.BOOKSTACK_API_ID }}
          API_SECRET: ${{ secrets.BOOKSTACK_API_SECRET }}
          BOOKSTACK_URL: ${{ secrets.BOOKSTACK_URL }}
        run: |
          echo "–ü–æ–ª—É—á–∞–µ–º ID –∫–Ω–∏–≥–∏ 'Githab Issues'..."
          
          # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–Ω–∏–≥
          response=$(curl -s -X GET "$BOOKSTACK_URL/api/books" \
            -H "Authorization: Token $API_ID:$API_SECRET" \
            -H "Accept: application/json")
          
          echo "API Response received"
          
          # –ò—â–µ–º –∫–Ω–∏–≥—É –ø–æ –∏–º–µ–Ω–∏
          book_id=$(echo "$response" | jq -r '.data[] | select(.name == "Githab Issues") | .id')
          
          if [ -z "$book_id" ] || [ "$book_id" = "null" ]; then
            echo "‚ùå –ö–Ω–∏–≥–∞ 'Githab Issues' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
            echo "–°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –∫–Ω–∏–≥—É..."
            
            create_response=$(curl -s -X POST "$BOOKSTACK_URL/api/books" \
              -H "Authorization: Token $API_ID:$API_SECRET" \
              -H "Content-Type: application/json" \
              -H "Accept: application/json" \
              -d '{
                "name": "Githab Issues",
                "description": "GitHub Issues synchronized via KCS"
              }')
            
            book_id=$(echo "$create_response" | jq -r '.id')
            
            if [ -z "$book_id" ] || [ "$book_id" = "null" ]; then
              echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∫–Ω–∏–≥–∏: $create_response"
              exit 1
            fi
            
            echo "‚úÖ –°–æ–∑–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –∫–Ω–∏–≥–∞ —Å ID: $book_id"
          else
            echo "‚úÖ –ù–∞–π–¥–µ–Ω–∞ –∫–Ω–∏–≥–∞ 'Githab Issues' —Å ID: $book_id"
          fi
          
          echo "book_id=$book_id" >> $GITHUB_OUTPUT

      - name: Create or Update BookStack Page
        env:
          API_ID: ${{ secrets.BOOKSTACK_API_ID }}
          API_SECRET: ${{ secrets.BOOKSTACK_API_SECRET }}
          BOOKSTACK_URL: ${{ secrets.BOOKSTACK_URL }}
          HTML_CONTENT: ${{ env.html_content }}
        run: |
          BOOK_ID="${{ steps.get_book_id.outputs.book_id }}"
          
          echo "–ò—Å–ø–æ–ª—å–∑—É–µ–º Book ID: $BOOK_ID"
          
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
          if [ "${{ github.event.action }}" = "closed" ]; then
            STATUS="‚úÖ –†–µ—à–µ–Ω–æ"
          elif [ "${{ github.event.action }}" = "reopened" ]; then
            STATUS="üîÑ –í —Ä–∞–±–æ—Ç–µ"
          else
            STATUS="üîÑ –í —Ä–∞–±–æ—Ç–µ"
          fi
          
          # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç
          FULL_CONTENT="<p><strong>GitHub Issue:</strong> <a href='${{ github.event.issue.html_url }}'>#${{ github.event.issue.number }}</a></p>"
          FULL_CONTENT="${FULL_CONTENT}<div>${HTML_CONTENT}</div>"
          FULL_CONTENT="${FULL_CONTENT}<p><strong>–°—Ç–∞—Ç—É—Å:</strong> $STATUS</p>"
          
          echo "–ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É..."
          
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º curl —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞–º–∏
          EXISTING_PAGE_RESPONSE=$(curl -s -X GET "$BOOKSTACK_URL/api/pages?book_id=$BOOK_ID" \
            -H "Authorization: Token $API_ID:$API_SECRET" \
            -H "Accept: application/json")
          
          EXISTING_PAGE=$(echo "$EXISTING_PAGE_RESPONSE" | jq -r ".data[] | select(.name == \"${{ github.event.issue.title }}\") | .id")
          
          # –°–æ–∑–¥–∞–µ–º JSON –¥–∞–Ω–Ω—ã–µ
          PAGE_TITLE="${{ github.event.issue.title }}"
          
          if [ -z "$EXISTING_PAGE" ] || [ "$EXISTING_PAGE" = "null" ]; then
            echo "–°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É: $PAGE_TITLE"
            
            # –°–æ–∑–¥–∞–µ–º JSON —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º jq
            JSON_DATA=$(jq -n \
              --arg name "$PAGE_TITLE" \
              --argjson book_id "$BOOK_ID" \
              --arg html "$FULL_CONTENT" \
              '{
                "name": $name,
                "book_id": $book_id,
                "html": $html,
                "tags": [
                  {"name": "github", "value": "issue-${{ github.event.issue.number }}"},
                  {"name": "source", "value": "github-actions"}
                ]
              }')
            
            echo "–û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ: $JSON_DATA"
            
            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$BOOKSTACK_URL/api/pages" \
              -H "Authorization: Token $API_ID:$API_SECRET" \
              -H "Content-Type: application/json" \
              -H "Accept: application/json" \
              -d "$JSON_DATA")
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            echo "HTTP Code: $HTTP_CODE"
            echo "Response: $BODY"
            
            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
              echo "‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ"
            else
              echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã"
              exit 1
            fi
            
          else
            echo "–û–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É ID: $EXISTING_PAGE"
            
            # –°–æ–∑–¥–∞–µ–º JSON –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            JSON_DATA=$(jq -n \
              --arg name "$PAGE_TITLE" \
              --arg html "$FULL_CONTENT" \
              '{
                "name": $name,
                "html": $html
              }')
            
            echo "–û—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–µ –¥–∞–Ω–Ω—ã–µ: $JSON_DATA"
            
            RESPONSE=$(curl -s -w "\n%{http_code}" -X PUT "$BOOKSTACK_URL/api/pages/$EXISTING_PAGE" \
              -H "Authorization: Token $API_ID:$API_SECRET" \
              -H "Content-Type: application/json" \
              -H "Accept: application/json" \
              -d "$JSON_DATA")
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')
            
            echo "HTTP Code: $HTTP_CODE"
            echo "Response: $BODY"
            
            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
              echo "‚úÖ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞"
            else
              echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã"
              exit 1
            fi
          fi
